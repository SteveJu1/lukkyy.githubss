---
layout: post
title:  "TCP-UDP"
date:       2017-10-06 
categories: Web
tags:  网络五层协议 
---

### UDP和TCP的特点

用户数据报协议UDP（User Datagram Protocal）：无连接，经最大可能交付，可以多对多通信，面向报文
传输控制协议TCP（Transmission Control Protocol）：面向连接的，提供可靠传输，支持流量控制，拥塞控制









### TCP首部格式

![](https://lukkyy.github.io/assets/IT/Web/154645.png)

**序号（seq）**：对传输的字节流进行编号，例如序号是100，表示报文段是从字节流的第100个位置开始

**确认号（ack）**：希望收到下一个报文段的序号，例如：A给Ｂ发送了一个报文段，报文段的序号是300，报文段长度是200。Ｂ则希望Ａ下一个报文段是501，ack=seq+1.

**确认 ACK** ：当 ACK=1 时**确认号字段有效**，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1

**同步 SYN** ：在连接建立时用来同步序号。当 SYN=1，ACK=0 **表示连接请求**。SYN=1，ACK=1表示**同意建立连接**

**终止 FIN** ：释放一个连接，当 FIN=1 时，表示**发送方的数据已发送完**，并要求释放连接。

### TCP三次握手

A为客户端，B为服务器

- 首先B处于LISTEN监听状态，等待客户端A的连接请求

- A向B发送连接请求，SYN=1，ACK=0，seq=x初始化序号x

- B接受到连接请求后；向A发送SYN=1，表示同意建立连接；ACK=1,序号seq=y，确认号ack=x+1

- A收到B的**连接确认**后，发送ACK=1，seq=x+1，ack=y+1

- B收到A的连接确认后，建立连接

  ![](https://lukkyy.github.io/assets/IT/Web/sanciwoshou.png)

**三次握手的原因**

为了防止失效的连接请求到达服务器后，让服务器打开不必要的连接，浪费服务器资源

客户端发送的连接请求如果在网络中滞留，长时间没收到服务器的响应。客户端会重新发送连接请求，服务器回应连接请求，如果不进行三次握手，滞留的连接请求到达服务器后，会建立两个连接。如果有三次握手客户端会忽略服务器对滞留的连接确认。

### TCP四次挥手

- A发送**连接释放**的报文，FIN=1

- B收到A的连接释放后，给A发出**连接释放确认**，但B还可以向A发送数据，确保数据已发送完

- 当B不再需要连接后，给A发送连接释放，FIN=1

- A 收到后B的连接释放后，给B发出连接释放确认，进入TIME-WAIT状态，等待 2 MSL（最大报文存活时间）后释放连接

- B 收到 A 的确认后释放连接

  ![](https://lukkyy.github.io/assets/IT/Web/sici.png)

**四次挥手的原因**

A发送连接释放之后，B收到了这个报文，进入了 CLOSE-WAIT 状态。是为了让B向A发完数据，数据传输完后，B才会发送连接释放。

A接收到B的连接释放需要等待时间 2MSL。

- 为了确保A的连接释放确认B能收到。如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
- 为了让本连接持续期内所产生的所有报文都从网络中消失



TCP 可靠传输通过超时重传来实现

**TCP滑动窗口**

窗口是用来缓存字节流的，接受方告诉发送方自己的窗口大小，发送方根据这个设置窗口大小

发送窗口内的字节从左到右开始发送，若发送窗口的字节已发送并收到接受确认，则窗口向右移动到第一个不是已发送并接受确认状态的字节

**TCP流量控制**

为了控制发送方的发送速率，保证接受方能及时处理

接受方发送的报文中窗口字段控制发送方的窗口大小